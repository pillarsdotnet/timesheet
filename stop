#!/bin/ksh
# Copyright (c) 2025 Robert August Vincent II <pillarsdotnet@gmail.com>
# Co-author: Cursor-AI.
# Record work stop time. If work has not yet started (last entry is STOP), insert a start one second
# after that stop, then add the new stop entry.

TIMESHEET=~/Documents/timesheet.log
now=$(date +%s)
last=$(tail -n 1 "$TIMESHEET" 2>/dev/null)
today=$(date +%Y-%m-%d)
case "$last" in
  'STOP|'*)
    # Only insert START then STOP|now if the previous stop was recorded today.
    prev_epoch=$(echo "$last" | cut -d'|' -f2)
    prev_date=$(date -r "$prev_epoch" +%Y-%m-%d 2>/dev/null) || prev_date=$(date -d "@$prev_epoch" +%Y-%m-%d 2>/dev/null)
    if [ -n "$prev_date" ] && [ "$prev_date" = "$today" ]; then
      insert_start=$((prev_epoch + 1))
      temp=$(mktemp)
      trap 'rm -f "$temp"' EXIT
      sed '$d' "$TIMESHEET" > "$temp" && \
        echo "START|${insert_start}|misc/unspecified" >> "$temp" && \
        echo "STOP|$now" >> "$temp" && \
        mv "$temp" "$TIMESHEET"
    else
      echo "STOP|$now" >> "$TIMESHEET"
    fi
    ;;
  *)
    echo "STOP|$now" >> "$TIMESHEET"
    ;;
esac
echo "Stopped at $(date)"
