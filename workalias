#!/bin/ksh
# Copyright (c) 2025 Robert August Vincent II <pillarsdotnet@gmail.com>
# Co-author: Cursor-AI.
# Interactively replace activity text in START entries from the current week.
# Args: <pattern> <replacement> â€” pattern is a string or regex; must match at least one activity this week.

TIMESHEET=~/Documents/timesheet.log

if [ $# -lt 2 ]; then
  echo "Usage: workalias <pattern> <replacement>" >&2
  echo "  pattern: string or regular expression matching activity text for this week." >&2
  echo "  replacement: string to substitute for matched activity." >&2
  exit 1
fi

pattern=$1
replacement=$2

if [ ! -f "$TIMESHEET" ]; then
  echo "workalias: no timesheet data found." >&2
  exit 1
fi

# Current week: Sunday 00:00:00 through Saturday 23:59:59 (local time).
today_ymd=$(date +%Y-%m-%d)
today_start=$(date -d "${today_ymd} 00:00:00" +%s 2>/dev/null) || today_start=$(date -j -f "%Y-%m-%d %H:%M:%S" "${today_ymd} 00:00:00" +%s 2>/dev/null)
dow=$(date +%w)
week_start=$((today_start - dow * 86400))
week_end=$((week_start + 7 * 86400 - 1))

# Output one block per match: line number, original line, new line (three lines each).
awk -F'|' -v pat="$pattern" -v repl="$replacement" -v ws="$week_start" -v we="$week_end" '
  /^START\|/ {
    if ($2 >= ws && $2 <= we && $3 ~ pat) {
      new = "START|" $2 "|" repl
      print NR; print $0; print new
    }
  }
' "$TIMESHEET" > /tmp/workalias_matches_$$
match_file=/tmp/workalias_matches_$$

if [ ! -s "$match_file" ]; then
  rm -f "$match_file"
  echo "workalias: no activities matching \"$pattern\" found for this week." >&2
  exit 1
fi

# Build list of line numbers to replace (user answered y).
replace_nums=""
while read -r line_num && read -r orig && read -r new_line; do
  echo "Original: $orig"
  echo "Replaced: $new_line"
  printf "Replace (y/n) "
  read -r answer < /dev/tty
  case "$answer" in
    [yY]) replace_nums="$replace_nums $line_num" ;;
    *) ;;
  esac
done < "$match_file"
rm -f "$match_file"

if [ -z "$replace_nums" ]; then
  exit 0
fi

# Apply replacements: write new file. For each line number, substitute the new line; others unchanged.
# We need to know the new line for each line_num. Re-run awk to get (line_num, new_line) for replace_nums only.
temp=$(mktemp)
trap 'rm -f "$temp"' EXIT
awk -F'|' -v pat="$pattern" -v repl="$replacement" -v ws="$week_start" -v we="$week_end" -v nums="$replace_nums" '
  BEGIN {
    n = split(nums, a, " ")
    for (i = 1; i <= n; i++) if (a[i] != "") replace[a[i]] = 1
  }
  /^START\|/ {
    if ($2 >= ws && $2 <= we && $3 ~ pat && replace[NR]) {
      print "START|" $2 "|" repl
      next
    }
  }
  { print }
' "$TIMESHEET" > "$temp" && mv "$temp" "$TIMESHEET"
