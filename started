#!/bin/ksh
# Copyright (c) 2025 Robert August Vincent II <pillarsdotnet@gmail.com>
# Co-author: Cursor-AI.
# Record a work start time in the past. First arg = start time; remaining args = activity (default: misc/unspecified).
# Time format: use GNU date -d style (e.g. "2025-02-16 09:00", "9:00 AM") or "YYYY-MM-DD HH:MM".

TIMESHEET=~/Documents/timesheet.log

if [ $# -lt 1 ]; then
  echo "Usage: started <start_time> [activity...]" >&2
  echo "  start_time is required (e.g. \"2025-02-16 09:00\" or \"9:00 AM\")." >&2
  exit 1
fi

start_time=$1
shift
activity="${*:-misc/unspecified}"

# Convert start_time to epoch: try GNU date -d, then BSD date -j -f
epoch=$(date -d "$start_time" +%s 2>/dev/null)
if [ -z "$epoch" ]; then
  epoch=$(date -j -f "%Y-%m-%d %H:%M:%S" "$start_time" +%s 2>/dev/null)
fi
if [ -z "$epoch" ]; then
  epoch=$(date -j -f "%Y-%m-%d %H:%M" "$start_time" +%s 2>/dev/null)
fi
if [ -z "$epoch" ]; then
  epoch=$(date -j -f "%H:%M" "$start_time" +%s 2>/dev/null)
fi
if [ -z "$epoch" ]; then
  echo "started: could not parse start time: $start_time" >&2
  exit 1
fi

# Only adjust an entry if it was made on the current day.
today=$(date +%Y-%m-%d)
last=$(tail -n 1 "$TIMESHEET" 2>/dev/null)
case "$last" in
  'START|'*)
    # Adjust the most recent start time only if that start was recorded today.
    start_epoch=$(echo "$last" | cut -d'|' -f2)
    start_date=$(date -r "$start_epoch" +%Y-%m-%d 2>/dev/null) || start_date=$(date -d "@$start_epoch" +%Y-%m-%d 2>/dev/null)
    if [ -n "$start_date" ] && [ "$start_date" = "$today" ]; then
      temp=$(mktemp)
      trap 'rm -f "$temp"' EXIT
      sed '$d' "$TIMESHEET" > "$temp" && \
        echo "START|${epoch}|${activity}" >> "$temp" && \
        mv "$temp" "$TIMESHEET"
      echo "Started: ${activity} at $(date -r "$epoch" 2>/dev/null || date -d "@$epoch" 2>/dev/null || echo "$epoch")"
      exit 0
    fi
    ;;
  'STOP|'*)
    stop_epoch=$(echo "$last" | cut -d'|' -f2)
    stop_date=$(date -r "$stop_epoch" +%Y-%m-%d 2>/dev/null) || stop_date=$(date -d "@$stop_epoch" +%Y-%m-%d 2>/dev/null)
    # Insert before this stop only if the stop was recorded today and epoch < stop_epoch.
    if [ "$epoch" -lt "$stop_epoch" ] && [ -n "$stop_date" ] && [ "$stop_date" = "$today" ]; then
      temp=$(mktemp)
      trap 'rm -f "$temp"' EXIT
      sed '$d' "$TIMESHEET" > "$temp" && \
        echo "START|${epoch}|${activity}" >> "$temp" && \
        echo "$last" >> "$temp" && \
        mv "$temp" "$TIMESHEET"
      echo "Started: ${activity} at $(date -r "$epoch" 2>/dev/null || date -d "@$epoch" 2>/dev/null || echo "$epoch")"
      exit 0
    fi
    ;;
esac

echo "START|${epoch}|${activity}" >> "$TIMESHEET"
echo "Started: ${activity} at $(date -r "$epoch" 2>/dev/null || date -d "@$epoch" 2>/dev/null || echo "$epoch")"
